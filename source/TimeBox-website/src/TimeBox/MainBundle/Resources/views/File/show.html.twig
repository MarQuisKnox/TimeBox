{% extends "TimeBoxMainBundle::layout.html.twig" %}

{% block container %}

    <div class="actions">
        <ul>
            <li>Actions:</li>
            <li>
                <a href=""><img src="{{ asset('img/icons/folder-add.png') }}" alt="folder add icon" />New folder</a>
            </li>
            <li>
                <a href="{{ path('time_box_main_file_upload') }}"><img src="{{ asset('img/icons/file-upload.png') }}" alt="upload icon" />Upload a new file</a>
            </li>
            <li class="FileRelatedAction">
                <a href=""><img src="{{ asset('img/icons/file-download.png') }}" alt="download icon" />Download</a>
            </li>
            <li class="FileRelatedAction">
                <a href=""><img src="{{ asset('img/icons/link.png') }}" alt="share icon" class="shareIcon" />Share</a>
            </li>
            <li class="FileRelatedAction">
                <a href=""><img src="{{ asset('img/icons/file-edit.png') }}" alt="rename icon" />Rename</a>
            </li>
            <li class="FileRelatedAction">
                <a href=""><img src="{{ asset('img/icons/file-delete.png') }}" alt="file delete icon" />Delete</a>
            </li>
            <li class="FileRelatedAction">
                <a href=""><img src="{{ asset('img/icons/file-go.png') }}" alt="move icon" />Move</a>
            </li>
            <li class="FileRelatedAction">
                <a href=""><img src="{{ asset('img/icons/file-copy.png') }}" alt="copy icon" />Copy</a>
            </li>
        </ul>
    </div>

    <table class="file">
        <thead>
            <tr>
                <td colspan="5" class="driveBreadcrumb">
                    <span class="fLeft"><a href="{{ path('time_box_main_file') }}">Drive</a></span>
                    <ul>
                        {% for folder in breadcrumb %}
                            <li><a href="{{ path('time_box_main_file', {'folderId':folder.id}) }}">{{ folder.name }}</a></li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
        </thead>
        <tbody class="selectable">
            <tr>
                <th class="fileCheckbox">{# Checkbox #}</th>
                <th class="fileType">{# Type #}</th>
                <th class="fileTitle">Title</th>
                <th class="size">Size</th>
                <th class="lastEdit">Last Edit</th>
            </tr>
            {% for folder in folders %}
            <tr class="folder">
                <td class="fileCheckbox checkboxImg"></td>
                <td class="fileType">
                    <img src="{{ asset('img/icons/folder.png') }}" alt="folder icon" />
                </td>
                <td class="fileTitle">
                    <a href="{{ path('time_box_main_file', {'folderId': folder.id}) }}">{{ folder.name }}</a>
                </td>
                <td class="size"></td>
                <td class="lastEdit"></td>
            </tr>
            {% endfor %}
            {% for file in files %}
            <tr data-id="{{ file.id }}" class="file">
                <td class="fileCheckbox checkboxImg"></td>
                <td class="fileType">
                {% if file.type in types %}
                    <img src="{{ asset('img/icons/file-' ~ file.type ~ '.png') }}" alt="{{ file.type }} icon" />
                {% else %}
                    <img src="{{ asset('img/icons/file.png') }}" alt="{{ file.type }} icon" title="{{ file.type }}" />
                {% endif %}
                </td>
                <td class="fileTitle">{{ file.name }}</td>
                <td class="size">
                {% if file.size > 1000000  %}
                    {{ file.size // 1000000 + 1 }} mo
                {% elseif file.size > 1000  %}
                    {{ file.size // 1000 + 1 }} ko
                {% else %}
                    {{ file.size }} o
                {% endif %}
                </td>
                <td class="lastEdit">
                {% if "now"|date("Y/m/d") == file.date|date('Y/m/d') %}
                    {{ file.date|date('H:i') }}
                {% else %}
                    {{ file.date|date('Y/m/d') }}
                {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}


{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/jquery-1.10.2.js') }}" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            $( "li.FileRelatedAction" ).hide();

            $("td.checkboxImg").click(function(evt) {
                $(this).parent().toggleClass("selected");
                selectedItemAction();
                return false;
            });

            $("table.file tr.file, table.file tr.folder").click(function(evt) {
                var nbSelectedItem = $('tr.selected').length;

                if (evt.ctrlKey) {
                    $(this).toggleClass("selected");
                }
                else if (evt.shiftKey) {
                    var firstIndex = $('table.file tr.selected').first().index();
                    var lastIndex = $(this).index();
                    if (lastIndex < firstIndex) {
                        firstIndex += lastIndex;
                        lastIndex = Math.abs(firstIndex - lastIndex);
                        firstIndex -= lastIndex;
                    }
                    $("table.file tr.file, table.file tr.folder").each(function( index ) {
                        var i = $(this).index();
                        if (i >= firstIndex && i <= lastIndex) {
                            $(this).addClass("selected");
                        }
                    });

                }
                else {
                    if (nbSelectedItem == 0) {
                        $(this).toggleClass("selected");
                    }
                    else if (nbSelectedItem == 1) {
                        $(this).siblings().removeClass("selected");
                        $(this).toggleClass("selected");
                    }
                    else if (nbSelectedItem > 0) {
                        $(this).siblings().removeClass("selected");
                    }
                }

                selectedItemAction();
            });
        });

        function selectedItemAction() {
            var nbSelectedItem = $('table.file tr.selected').length;
            var nbSelectedFile = $('table.file tr.file.selected').length;
            if (nbSelectedItem == 1) {
                $( "li.FileRelatedAction" ).slideDown( "slow" );
                hideVersions();

                if (nbSelectedFile == 1) {
                    var fileId = $('table.file tr.file.selected').attr('data-id');
                    $.ajax({
                        url: "{{ path('time_box_main_file_versions') }}",
                        type: "POST",
                        data: {'fileId': fileId},
                        success: function( data ) {
                            $('tr.file.selected').after( data );
                            $("tr.version ul").hide().slideDown();
                        }
                    });
                }
            }
            else if (nbSelectedItem > 1) {
                $( "li.FileRelatedAction" ).slideDown( "slow" );
                hideVersions();
            }
            else {
                $( "li.FileRelatedAction" ).slideUp( "slow" );
                hideVersions();
            }
        }

        function hideVersions() {
            $("tr.version ul").slideUp(function() {
                $("tr.version").remove();
            });
        }
    </script>
{% endblock %}
